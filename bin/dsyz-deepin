#!/usr/bin/env bash

# SPDX-License-Identifier: GPL-3.0-or-later
# SPDX-FileCopyrightText: Chen Linxuan <me@black-desk.cn>

# NOTE:
# Use /usr/bin/env to find shell interpreter for better portability.
# Reference: https://en.wikipedia.org/wiki/Shebang_%28Unix%29#Portability

# NOTE:
# Exit immediately if any commands (even in pipeline)
# exits with a non-zero status.
set -e
set -o pipefail

# WARNING:
# This is not reliable when using POSIX sh
# and current script file is sourced by `source` or `.`
CURRENT_SOURCE_FILE_PATH="${BASH_SOURCE[0]:-$0}"
CURRENT_SOURCE_FILE_NAME="$(basename -- "$CURRENT_SOURCE_FILE_PATH")"

# This function log messages to stderr works like printf
# with a prefix of the current script name.
# Arguments:
#   $1 - The format string.
#   $@ - Arguments to the format string, just like printf.
function log() {
	local format="$1"
	shift
	# shellcheck disable=SC2059
	printf "$CURRENT_SOURCE_FILE_NAME: $format\n" "$@" >&2 || true
}

function main() {
	log "[INFO] This is a wrapper script for dsyz to use the Deepin kernel repository."
	log "[INFO] All arguments will be passed to dsyz."

	KERNEL_CONFIG_SCRIPT="$(mktemp)"
	trap 'rm -f "$KERNEL_CONFIG_SCRIPT"' EXIT

	ARCH="$(uname -m)"
	if [ "$ARCH" == "x86_64" ]; then
		ARCH="x86"
	else
		log "[ERROR] Unsupported architecture: $ARCH"
	fi

	cat >"$KERNEL_CONFIG_SCRIPT" <<EOF
make deepin_${ARCH}_desktop_defconfig
make kvm_guest.config

./scripts/config --set-val CONFIG_KCOV y
./scripts/config --set-val CONFIG_DEBUG_INFO_DWARF4 y
./scripts/config --set-val CONFIG_KASAN y
./scripts/config --set-val CONFIG_KASAN_INLINE y
./scripts/config --set-val CONFIG_CONFIGFS_FS y
./scripts/config --set-val CONFIG_SECURITYFS y
./scripts/config --set-val CONFIG_CMDLINE_BOOL y
./scripts/config --set-str CONFIG_CMDLINE "net.ifnames=0"

./scripts/config --set-val CONFIG_BINFMT_MISC y
./scripts/config --set-val CONFIG_E1000 y

make olddefconfig
EOF
	DSYZ_KERNEL_REPO="${DSYZ_KERNEL_REPO:-https://github.com/deepin-community/kernel.git}"
	env \
		DSYZ_KERNEL_REPO="$DSYZ_KERNEL_REPO" \
		DSYZ_KERNEL_CONFIG_SCRIPT="$KERNEL_CONFIG_SCRIPT" \
		dsyz "$@"
}

main "$@"
